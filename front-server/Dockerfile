# 1ë‹¨ê³„: ë¹Œë“œ í™˜ê²½
FROM node:22-bullseye AS builder

WORKDIR /usr/src/app/front-server

# íŒ¨í‚¤ì§€ íŒŒì¼ ë¨¼ì € ë³µì‚¬
COPY package*.json ./

# npm ìºì‹œ ì •ë¦¬ + íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN npm cache clean --force
RUN npm ci --legacy-peer-deps

# rollup ë¬¸ì œ í•´ê²° (ë¹Œë“œ í™˜ê²½ì— ë§ê²Œ ë‹¤ì‹œ ì„¤ì¹˜)
RUN npm rebuild rollup

# ì†ŒìŠ¤ ë³µì‚¬
COPY . .

# ViteëŠ” dev ì„œë²„ ì‹¤í–‰ (build ì•ˆ í•¨, npm run build ëŒ€ì‹  dev)
# ğŸ‘‰ AWS EBì—ì„œ run timeì— dev ì„œë²„ ë„ìš¸ ê±°ë¼ build ë‹¨ê³„ ì—†ìŒ

# 2ë‹¨ê³„: ëŸ°íƒ€ì„ í™˜ê²½
FROM node:22-bullseye

WORKDIR /usr/src/app/front-server

# timezone ì„¤ì •
RUN ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime && \
    echo "Asia/Seoul" > /etc/timezone

# builderì—ì„œ node_modulesë§Œ ë³µì‚¬
COPY --from=builder /usr/src/app/front-server/node_modules ./node_modules
COPY --from=builder /usr/src/app/front-server/package*.json ./
COPY --from=builder /usr/src/app/front-server ./

# 5173 í¬íŠ¸ ë…¸ì¶œ (vite dev ì„œë²„)
EXPOSE 5173

# Vite dev ì„œë²„ ì‹¤í–‰
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
